---
# ============================================================================
# BOOTSTRAP.YML - Prepare un serveur vierge
# ============================================================================
#
# ┌─────────────────────────────────────────────────────────────────────────┐
# │                      BOOTSTRAP SERVEUR NEUF                            │
# ├─────────────────────────────────────────────────────────────────────────┤
# │                                                                         │
# │  ACTIONS EFFECTUEES :                                                   │
# │  ────────────────────                                                   │
# │    1. Deploiement clef SSH (si bootstrap_ssh_public_key defini)         │
# │    2. Installation paquets de base                                      │
# │    3. Configuration systeme (timezone, hostname, locale)                │
# │    4. Creation repertoires /data/*                                      │
# │    5. Hardening SSH (desactive mdp, port custom)                        │
# │    6. Installation Docker + Docker Compose                              │
# │                                                                         │
# │  VARIABLES IMPORTANTES (defaults/main.yml des roles) :                  │
# │  ──────────────────────────────────────────────────────                 │
# │    bootstrap_ssh_public_key : Clef SSH a deployer (optionnel)           │
# │    bootstrap_timezone       : Timezone (defaut: Europe/Paris)           │
# │    bootstrap_hostname       : Hostname (defaut: inventory_hostname)     │
# │    bootstrap_ssh_port       : Port SSH (defaut: 22)                     │
# │                                                                         │
# │  TAGS DISPONIBLES :                                                     │
# │  ───────────────────                                                    │
# │    bootstrap   : Configuration systeme complete                         │
# │    docker      : Installation Docker uniquement                         │
# │    hardening   : Hardening SSH uniquement                               │
# │    ssh         : Deploiement clef SSH uniquement                        │
# │                                                                         │
# └─────────────────────────────────────────────────────────────────────────┘
#
# Usage:
#   # Premier run (authentification par mot de passe)
#   ansible-playbook playbooks/bootstrap.yml --ask-pass
#
#   # Runs suivants (authentification par clef)
#   ansible-playbook playbooks/bootstrap.yml
#
#   # Dry run
#   ansible-playbook playbooks/bootstrap.yml --check --diff
#
#   # Docker uniquement
#   ansible-playbook playbooks/bootstrap.yml --tags docker
#
#   # Sans hardening SSH (premier run, garder acces mot de passe)
#   ansible-playbook playbooks/bootstrap.yml --ask-pass --skip-tags hardening
#
# ============================================================================

- name: Bootstrap server
  hosts: remote
  become: true
  gather_facts: true

  pre_tasks:
    - name: Wait for server to be reachable
      ansible.builtin.wait_for_connection:
        timeout: 30

    - name: Gather facts
      ansible.builtin.setup:

  roles:
    - role: bootstrap
      tags: [bootstrap]

    - role: docker_setup
      tags: [docker]

  post_tasks:
    - name: Display server info
      ansible.builtin.debug:
        msg:
          - "Hostname: {{ ansible_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Kernel: {{ ansible_kernel }}"
          - "IP: {{ ansible_default_ipv4.address | default('N/A') }}"
          - "RAM: {{ ansible_memtotal_mb }}MB"
          - "Disk: {{ ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first | human_readable }}"
      tags: [always]
