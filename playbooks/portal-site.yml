---
# =============================================================================
# PORTAL-SITE.YML - Deploiement complet du Portail Securise
# =============================================================================
#
# ┌─────────────────────────────────────────────────────────────────────────┐
# │                 DEPLOIEMENT PORTAIL SECURISE COMPLET                   │
# ├─────────────────────────────────────────────────────────────────────────┤
# │                                                                         │
# │  EQUIVALENT DE : deploy.sh (sans arguments)                             │
# │                                                                         │
# │  ORDRE DE DEPLOIEMENT :                                                 │
# │  ───────────────────────                                                │
# │    Phase 1 - Infrastructure :                                           │
# │      common       : Prereqs, certs, secrets, networks Docker            │
# │                                                                         │
# │    Phase 2 - Identity Provider :                                        │
# │      keycloak     : Authentification OIDC (requis par tous)             │
# │                                                                         │
# │    Phase 3 - Services Core :                                            │
# │      oauth2_proxy : Auth proxy + nginx reverse proxy                    │
# │                                                                         │
# │    Phase 4 - Applications Core :                                        │
# │      guacamole    : Bastion RDP/SSH/VNC                                 │
# │      credentials  : API stockage mots de passe                          │
# │      portal_api   : Portail web + API                                   │
# │                                                                         │
# │    Phase 5 - Services Optionnels :                                      │
# │      vaultwarden  : Gestionnaire mots de passe (si DEPLOY_VAULTWARDEN)  │
# │      headscale    : VPN mesh (si DEPLOY_HEADSCALE)                      │
# │      linshare     : Partage fichiers (si DEPLOY_LINSHARE)               │
# │      bookstack    : Wiki (si DEPLOY_BOOKSTACK)                          │
# │                                                                         │
# │  TAGS DISPONIBLES :                                                     │
# │  ───────────────────                                                    │
# │    core      : Phases 1-4 uniquement                                    │
# │    identity  : Keycloak uniquement                                      │
# │    optional  : Services optionnels uniquement                           │
# │    <service> : Un service specifique (ex: guacamole, headscale)         │
# │                                                                         │
# └─────────────────────────────────────────────────────────────────────────┘
#
# Usage:
#   ansible-playbook playbooks/portal-site.yml                  # Complet
#   ansible-playbook playbooks/portal-site.yml --tags core      # Core only
#   ansible-playbook playbooks/portal-site.yml --tags keycloak  # Keycloak seul
#   ansible-playbook playbooks/portal-site.yml --check --diff   # Dry run
#
# =============================================================================

- name: Deploy Portail Securise - Infrastructure complete
  hosts: portal_servers
  become: true

  roles:
    # =========================================================================
    # Phase 1 : Infrastructure de base
    # =========================================================================
    - role: common
      tags: [common, always]

    # =========================================================================
    # Phase 2 : Identity Provider (doit demarrer en premier)
    # =========================================================================
    - role: keycloak
      tags: [keycloak, identity, core]

    # =========================================================================
    # Phase 3 : Services core (auth + reverse proxy)
    # =========================================================================
    - role: oauth2_proxy
      tags: [oauth2-proxy, auth, core]

    # =========================================================================
    # Phase 4 : Applications core
    # =========================================================================
    - role: guacamole
      when: deploy_guacamole | bool
      tags: [guacamole, core]

    - role: credentials_api
      when: deploy_credentials_api | bool
      tags: [credentials-api, core]

    - role: portal_api
      tags: [portal-api, portal, core]

    # =========================================================================
    # Phase 5 : Services optionnels
    # =========================================================================
    - role: vaultwarden
      when: deploy_vaultwarden | bool
      tags: [vaultwarden, optional]

    - role: headscale
      when: deploy_headscale | bool
      tags: [headscale, vpn, optional]

    - role: linshare
      when: deploy_linshare | bool
      tags: [linshare, optional]

    - role: bookstack
      when: deploy_bookstack | bool
      tags: [bookstack, optional]

  # ===========================================================================
  # Post-deploiement : verification sante
  # ===========================================================================
  post_tasks:
    - name: List running containers
      ansible.builtin.command:
        cmd: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
      register: docker_ps
      changed_when: false
      tags: [always, health]

    - name: Display running services
      ansible.builtin.debug:
        msg: "{{ docker_ps.stdout_lines }}"
      tags: [always, health]
