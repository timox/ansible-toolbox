# oauth2-proxy Configuration Template
# Remplacer les variables  avec envsubst

## Provider OIDC (Keycloak)
provider = "oidc"
provider_display_name = "Keycloak SSO"
oidc_issuer_url = ""
client_id = ""
client_secret = ""
redirect_url = "https://portail.sdis25.fr/oauth2/callback"

## Scopes OIDC
scope = "openid email profile groups"
oidc_groups_claim = "groups"

## Email verification (désactivé pour utilisateurs AD/LDAP synchronisés)
# Les emails AD sont considérés comme fiables même si non marqués "verified" dans Keycloak
insecure_oidc_allow_unverified_email = true

## SSL/TLS
https_address = ":44180"
tls_cert_file = "/certs/wildcard.sdis25.fr.crt"
tls_key_file = "/certs/wildcard.sdis25.fr.key"

## Upstreams
# oauth2-proxy proxifie vers nginx sur port 80 après authentification
upstreams = ["http://nginx-apps:80"]

## Cookies
cookie_name = "_oauth2_proxy"
cookie_secret = ""
cookie_domains = ".sdis25.fr"
cookie_expire = "8h"
cookie_refresh = "1h"
cookie_secure = true
cookie_httponly = true
cookie_samesite = "lax"

## Headers injectés vers upstream
set_xauthrequest = true
pass_access_token = false
pass_authorization_header = false
pass_user_headers = true
# Headers disponibles pour les applications:
# X-Forwarded-User: email de l'utilisateur
# X-Forwarded-Email: email
# X-Forwarded-Groups: groupes (comma-separated)
# X-Forwarded-Preferred-Username: username

## Session storage
# Option 1: Cookie-based (default, stateless)
session_store_type = "cookie"

# Option 2: Redis pour HA (décommenter si profil ha activé)
# session_store_type = "redis"
# redis_connection_url = "redis://oauth2-redis:6379"

## Métriques Prometheus
metrics_address = ":9090"

## Logging
request_logging = true
auth_logging = true
standard_logging = true
logging_filename = ""
logging_max_size = 100
logging_max_age = 7
logging_local_time = true
logging_compress = true

## Email domains (accepter tous)
email_domains = "*"

## Whitelist des domaines autorisés pour les redirections (logout, etc.)
whitelist_domains = ".sdis25.fr"

## Autorisation par groupes (optionnel, déléguer aux apps via nginx)
# Si vous voulez filtrer au niveau oauth2-proxy (non recommandé):
# allowed_groups = ["admin-infra", "admin-standard", "utilisateurs"]

## Reverse Proxy Configuration
reverse_proxy = true
real_client_ip_header = "X-Real-IP"

## Timeouts
ping_path = "/ping"
ready_path = "/ready"
