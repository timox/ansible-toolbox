# =============================================================================
# PORTAIL SECURISE - VARIABLES D'ENVIRONNEMENT
# =============================================================================
#
# INSTRUCTIONS :
# 1. Copier ce fichier : cp .env.example .env
# 2. Configurer DOMAIN et KEYCLOAK_ISSUER (obligatoires)
# 3. Recuperer les secrets clients depuis Keycloak
# 4. Lancer ./deploy.sh (les secrets vides seront auto-generes)
#
# LEGENDE :
#   [AUTO]     = Auto-genere par deploy.sh si vide
#   [KEYCLOAK] = A recuperer depuis Keycloak Admin
#   [REQUIRED] = Obligatoire, pas de valeur par defaut
#
# =============================================================================

# =============================================================================
# CONFIGURATION GLOBALE [REQUIRED]
# =============================================================================

# Domaine principal (ex: example.com, poc.local)
DOMAIN=example.com

# =============================================================================
# KEYCLOAK - CONFIGURATION OIDC [REQUIRED]
# =============================================================================
#
# KEYCLOAK_ISSUER : URL complete de l'issuer OIDC (seule variable obligatoire)
# Les autres variables sont auto-derivees si vides.
#
# Exemple : https://keycloak.example.com/realms/portal
#           https://auth.example.com:8443/realms/mycompany
KEYCLOAK_ISSUER=https://keycloak.example.com/realms/portal

# Variables derivees [AUTO] - extraites de KEYCLOAK_ISSUER si vides
# Ne remplir que si different de l'issuer (cas avances)
KEYCLOAK_URL=
KEYCLOAK_HOST=
KEYCLOAK_REALM=

# URL backend pour nginx reverse proxy vers Keycloak
# Supporte HTTP ou HTTPS (certificats auto-signes acceptes)
#
# Exemples selon votre configuration :
#   - Keycloak local HTTP    : http://keycloak:8080
#   - Keycloak local HTTPS   : https://keycloak:8443
#   - Keycloak externe HTTPS : https://auth.example.com
#   - Keycloak sur host      : http://host.docker.internal:8080
#   - Keycloak meme URL      : (laisser vide, utilise KEYCLOAK_ISSUER)
#
# [AUTO] Si vide, derive de KEYCLOAK_ISSUER (ex: https://keycloak.example.com)
KEYCLOAK_BACKEND_URL=
# URL Keycloak pour les scripts hote (deploy.sh, setup-*.sh)
# Docker: http://keycloak:8080 ne fonctionne pas depuis l'hote
# Defaut: http://localhost:${KEYCLOAK_HTTP_PORT:-8080}
KEYCLOAK_HOST_BACKEND_URL=http://localhost:8080

# =============================================================================
# VERSIONS DOCKER (optionnel - versions stables par defaut)
# =============================================================================

NGINX_VERSION=1.27-alpine
REDIS_VERSION=7.4-alpine
POSTGRES_VERSION=15.10-alpine
GUACAMOLE_VERSION=1.6.0
OAUTH2_PROXY_VERSION=v7.6.0
LINSHARE_VERSION=6.0
OIDCWARDEN_VERSION=latest
HEADSCALE_VERSION=0.27.1
BOOKSTACK_VERSION=24.10.1
KEYCLOAK_VERSION=26.0.7

# =============================================================================
# OAUTH2-PROXY - REVERSE PROXY SSO
# =============================================================================

# Client OIDC oauth2-proxy [KEYCLOAK]
# Creer dans Keycloak : Access Type = confidential
# Redirect URIs : https://*.example.com/oauth2/callback
# Recuperer dans Keycloak: Credentials > Client Secret
OIDC_CLIENT_ID=oauth2-proxy
OIDC_CLIENT_SECRET=

# Cookie secret pour sessions [AUTO]
# Genere avec : python3 -c 'import os,base64; print(base64.urlsafe_b64encode(os.urandom(32)).decode())'
COOKIE_SECRET=

# Certificats SSL wildcard
TLS_CERT_FILE=/data/certs/wildcard.example.com.crt
TLS_KEY_FILE=/data/certs/wildcard.example.com.key

# Ports (optionnel)
OAUTH2_PROXY_HTTP_PORT=4180
OAUTH2_PROXY_HTTPS_PORT=44180
OAUTH2_PROXY_METRICS_PORT=9090
NGINX_HTTP_PORT=80
NGINX_HTTPS_PORT=443

# =============================================================================
# GUACAMOLE - BASTION RDP/SSH/VNC
# =============================================================================

# Base de donnees [AUTO]
GUACAMOLE_DB_PASSWORD=

# Client OIDC Guacamole [KEYCLOAK]
# Creer dans Keycloak : Access Type = public (implicit flow)
# Redirect URIs : https://guacamole.example.com/*
GUACAMOLE_OIDC_CLIENT_ID=guacamole

# Groupes Keycloak pour Guacamole
# GUACAMOLE_ADMIN_GROUP utilise ${ADMIN_GROUP} par defaut
# GUACAMOLE_ALLOWED_GROUP vide = tous les utilisateurs autorises
GUACAMOLE_ALLOWED_GROUP=

# Mot de passe compte local guacadmin (optionnel) [AUTO]
GUACAMOLE_ADMIN_PASSWORD=

# PostgreSQL UID/GID (70=alpine, 999=debian)
POSTGRES_DATA_UID=70
POSTGRES_DATA_GID=70

# =============================================================================
# LINSHARE - PARTAGE DE FICHIERS (DEPLOY_LINSHARE=true)
# =============================================================================

# Bases de donnees [AUTO]
LINSHARE_DB_PASSWORD=
LINSHARE_MONGO_PASSWORD=

# Client OIDC LinShare [KEYCLOAK]
# Creer dans Keycloak : Access Type = confidential, PKCE S256
# Redirect URIs : https://linshare.example.com/*
# Mappers requis : groups, domain_discriminator (hardcoded = votre domaine)
# Recuperer dans Keycloak: Credentials > Client Secret
LINSHARE_OIDC_CLIENT_ID=linshare
LINSHARE_OIDC_CLIENT_SECRET=

# Admin email
LINSHARE_ADMIN_EMAIL=admin@example.com

# Quotas (en octets)
# 100 MB
LINSHARE_MAX_FILE_SIZE=104857600
# 10 GB
LINSHARE_QUOTA_DEFAULT=10737418240

# Ports debug (optionnel)
LINSHARE_USER_PORT=8082
LINSHARE_ADMIN_PORT=8083

# Hosts internes (ne pas modifier)
POSTGRES_HOST=linshare-db
POSTGRES_PORT=5432
POSTGRES_DATABASE=linshare
POSTGRES_USER=linshare
MONGODB_HOST=linshare-mongodb
MONGODB_PORT=27017
MONGODB_DATABASE=linshare
MONGODB_USER=linshare
MONGODB_AUTH_SOURCE=linshare
CLAMAV_HOST=linshare-antivirus
CLAMAV_PORT=3310
THUMBNAIL_HOST=linshare-thumbnail
THUMBNAIL_PORT=8080

# =============================================================================
# VAULTWARDEN/OIDCWARDEN - COFFRE-FORT (DEPLOY_VAULTWARDEN=true)
# =============================================================================
# Fork Vaultwarden avec SSO avance : role mapping + org mapping
# Doc : https://github.com/Timshel/OIDCWarden

# Token admin pour /admin [AUTO]
# Genere avec : openssl rand -base64 48
VAULTWARDEN_ADMIN_TOKEN=

# Port (optionnel)
VAULTWARDEN_PORT=8222

# Inscription
VAULTWARDEN_SIGNUPS_ALLOWED=false
VAULTWARDEN_INVITATIONS_ALLOWED=true

# Client OIDC Vaultwarden [KEYCLOAK]
# Creer dans Keycloak : Access Type = confidential
# Redirect URIs : https://vault.example.com/*
# Mappers requis : groups, client roles (admin/user)
# Recuperer dans Keycloak: Credentials > Client Secret
OIDCWARDEN_CLIENT_ID=vaultwarden
OIDCWARDEN_CLIENT_SECRET=

# SSO options
# true = desactive login email/password
OIDCWARDEN_SSO_ONLY=false

# Role mapping (admin/user depuis Keycloak)
OIDCWARDEN_ROLES_ENABLED=true
OIDCWARDEN_ROLES_TOKEN_PATH=/resource_access/vaultwarden/roles

# Org mapping (groupes Keycloak → organisations)
# OIDCWARDEN_ORGS_REVOCATION : revoquer si retire du groupe
OIDCWARDEN_ORGS_ENABLED=true
OIDCWARDEN_ORGS_REVOCATION=true
OIDCWARDEN_ORGS_TOKEN_PATH=/groups

# =============================================================================
# HEADSCALE - VPN MESH (DEPLOY_HEADSCALE=true)
# =============================================================================
# Control plane Tailscale self-hosted avec auth OIDC
# Doc : https://headscale.net/

# Client OIDC Headscale [KEYCLOAK]
# Creer dans Keycloak : Access Type = confidential
# Redirect URIs : https://vpn.example.com/oidc/callback
# Recuperer dans Keycloak: Credentials > Client Secret
HEADSCALE_OIDC_CLIENT_SECRET=

# Ports
HEADSCALE_HTTPS_PORT=9443
HEADSCALE_METRICS_PORT=9091

# Headplane UI (optionnel, activer avec --profile ui)
HEADPLANE_VERSION=latest
HEADPLANE_PORT=3000
# [AUTO]
HEADPLANE_COOKIE_SECRET=
HEADSCALE_UI_PORT=8000

# API Key pour UI (generer apres deploiement)
# docker exec headscale headscale apikeys create
HEADSCALE_API_KEY=

# =============================================================================
# BOOKSTACK - WIKI (DEPLOY_BOOKSTACK=true)
# =============================================================================
# Wiki avec auth via oauth2-proxy (headers)
# Necessite une base MariaDB/MySQL externe

BOOKSTACK_APP_URL=https://wiki.example.com

# Base de donnees externe [REQUIRED si active]
BOOKSTACK_DB_HOST=mariadb.example.com
BOOKSTACK_DB_PORT=3306
BOOKSTACK_DB_USER=bookstack
# Mot de passe de la base de donnees externe
BOOKSTACK_DB_PASS=
BOOKSTACK_DB_DATABASE=bookstack

# Config
BOOKSTACK_CONFIG_PATH=/data/bookstack_config
BOOKSTACK_SESSION_DRIVER=redis
BOOKSTACK_PORT=6875

# UID/GID fichiers
PUID=1001
PGID=1001
TZ=Europe/Paris

# =============================================================================
# CREDENTIALS-API - GESTION CREDENTIALS RDP (DEPLOY_CREDENTIALS_API=true)
# =============================================================================
# API pour stocker les credentials RDP (utilise PostgreSQL de Guacamole)

# Cle de chiffrement AES-256 [AUTO]
# Genere avec : openssl rand -base64 32
CREDENTIALS_ENCRYPTION_KEY=

# Expiration en heures (0 = jamais)
CREDENTIALS_EXPIRY_HOURS=8

# =============================================================================
# KEYCLOAK AUTONOME (optionnel - ./deploy.sh --service keycloak)
# =============================================================================
# Deployer un Keycloak local si pas de Keycloak existant

# Admin [AUTO si vide]
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=

# Base de donnees [AUTO]
KEYCLOAK_DB_NAME=keycloak
KEYCLOAK_DB_USER=keycloak
KEYCLOAK_DB_PASSWORD=

# Reseau
KEYCLOAK_HOSTNAME=keycloak.example.com
KEYCLOAK_PROXY_MODE=edge
KEYCLOAK_HOSTNAME_STRICT=false
KEYCLOAK_HTTP_ENABLED=true
KEYCLOAK_HTTP_PORT=8080
KEYCLOAK_IMPORT_REALM=false

# =============================================================================
# PORTAIL DYNAMIQUE (optionnel - listing apps depuis Keycloak API)
# =============================================================================
# Service account pour lister les apps depuis Keycloak
# Creer dans realm master avec role view-clients
# Recuperer dans Keycloak: master realm > Clients > portal-api > Credentials
KEYCLOAK_SERVICE_CLIENT_ID=portal-api
KEYCLOAK_SERVICE_CLIENT_SECRET=
# Realms a interroger (comma-separated)
KEYCLOAK_REALMS=portal

# =============================================================================
# GROUPES KEYCLOAK
# =============================================================================
# Ces groupes sont crees par ./keycloak/scripts/setup-groups.sh
# et utilises dans les templates nginx, headscale, etc.

# Groupe admins infrastructure (acces complet a tous les services)
ADMIN_GROUP=admin-infra

# Groupe admins applicatifs (monitoring, services admin)
ADMIN_APP_GROUP=admin-app

# Groupe utilisateurs standards (services metier)
USER_GROUP=utilisateurs

# =============================================================================
# SERVICES A DEPLOYER
# =============================================================================
# true = deploye, false = ignore

DEPLOY_OAUTH2_PROXY=true
DEPLOY_GUACAMOLE=true
DEPLOY_CREDENTIALS_API=true
DEPLOY_LINSHARE=false
DEPLOY_HEADSCALE=false
DEPLOY_BOOKSTACK=false
DEPLOY_VAULTWARDEN=false

# =============================================================================
# HOSTNAMES DES SERVICES
# =============================================================================
# Par defaut: <service>.${DOMAIN}
# Personnalisable pour deploiements distribues ou noms DNS differents
# Laisser vide pour utiliser le defaut

# Portail principal (point d'entree)
PORTAL_HOSTNAME=
# Guacamole (bastion RDP/SSH/VNC)
GUACAMOLE_HOSTNAME=
# Vaultwarden (gestionnaire mots de passe)
VAULTWARDEN_HOSTNAME=
# LinShare (partage fichiers)
LINSHARE_HOSTNAME=
LINSHARE_ADMIN_HOSTNAME=
# Headscale (VPN mesh)
HEADSCALE_HOSTNAME=
# BookStack (wiki)
BOOKSTACK_HOSTNAME=
# Keycloak (si deploye localement)
KEYCLOAK_PROXY_HOSTNAME=

# =============================================================================
# SMTP - NOTIFICATIONS EMAIL (optionnel)
# =============================================================================

LINSHARE_SMTP_HOST=smtp.example.com
LINSHARE_SMTP_PORT=587
LINSHARE_SMTP_USER=
LINSHARE_SMTP_PASSWORD=
LINSHARE_SMTP_FROM=noreply@example.com
SMTP_TLS=true
SMTP_AUTH=true

# =============================================================================
# DOCKER
# =============================================================================

COMPOSE_PARALLEL_LIMIT=4

# =============================================================================
# APPLICATIONS DISTANTES (sur autres hôtes)
# =============================================================================
#
# Pour intégrer des applications déployées sur d'autres serveurs.
# nginx-apps fera proxy vers ces backends via le réseau (pas Docker).
#
# Voir: oauth2-proxy/nginx/remote-app.conf.example
#
# Prérequis: règles firewall autorisant VLAN-A → VLAN de l'app distante
#
# =============================================================================

# GLPI (exemple)
#GLPI_BACKEND_HOST=192.168.10.50
#GLPI_BACKEND_PORT=8080

# Zabbix (exemple)
#ZABBIX_BACKEND_HOST=zabbix.internal
#ZABBIX_BACKEND_PORT=8080

# Grafana (exemple)
#GRAFANA_BACKEND_HOST=monitoring.internal
#GRAFANA_BACKEND_PORT=3000

# Application custom (exemple)
#MYAPP_BACKEND_HOST=10.0.5.100
#MYAPP_BACKEND_PORT=8080
