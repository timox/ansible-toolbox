################################################################################
# Zabbix Agent 2 - UserParameter Configuration
# Internet Connectivity Check (sans ICMP/ping) avec métriques détaillées
#
# IMPORTANT: Zabbix Agent 2 nécessite une configuration spécifique
#
# OPTION 1 - Configuration directe dans zabbix_agent2.conf (RECOMMANDÉ):
#   1. Éditer: /etc/zabbix/zabbix_agent2.conf
#   2. Ajouter les lignes UserParameter à la fin du fichier
#   3. Redémarrer: systemctl restart zabbix-agent2
#
# OPTION 2 - Configuration via fichier Include:
#   1. Vérifier que zabbix_agent2.conf contient:
#      Include=/etc/zabbix/zabbix_agent2.d/*.conf
#   2. Copier ce fichier vers: /etc/zabbix/zabbix_agent2.d/
#   3. Redémarrer: systemctl restart zabbix-agent2
#
# Installation des scripts:
#   cp scripts/*.sh /usr/local/bin/
#   chmod +x /usr/local/bin/check-*.sh
#
# Tests depuis serveur Zabbix:
#   zabbix_get -s <IP_AGENT> -k internet.connectivity.check
#   zabbix_get -s <IP_AGENT> -k internet.dns.response_time
#   zabbix_get -s <IP_AGENT> -k 'internet.http.response_time[https://www.cloudflare.com/cdn-cgi/trace]'
#
# Vérifier les logs en cas d'erreur:
#   journalctl -u zabbix-agent2 -f
#
# Version: 2.0
# Date: 2025-11-23
################################################################################

# 1. UserParameter principal - État de connectivité
# Retourne: 1 (OK), 0.5 (DEGRADED), 0 (LOST)
# Teste TOUS les endpoints et collecte les métriques
UserParameter=internet.connectivity.check,/usr/local/bin/check-internet-connectivity.sh 5

# 2. UserParameter - Temps de réponse DNS (en millisecondes)
# Mesure le temps de résolution DNS via serveur spécifique
# Usage: internet.dns.response_time[8.8.8.8,google.com]
# Retourne: temps en ms (float) ou -1 si erreur
UserParameter=internet.dns.response_time[*],/usr/local/bin/check-dns-response-time.sh "$1" "$2"

# 3. UserParameter - Temps de réponse HTTP (en millisecondes)
# Mesure le temps de réponse HTTP pour une URL spécifique
# Usage: internet.http.response_time[https://www.cloudflare.com/cdn-cgi/trace,5]
# Param1: URL complète, Param2: timeout (optionnel, défaut 5s)
# Retourne: temps en ms (float) ou -1 si erreur
UserParameter=internet.http.response_time[*],/usr/local/bin/check-http-response-time.sh "$1" "$2"

# 4. UserParameter - Nombre d'endpoints accessibles
# Retourne le nombre d'endpoints HTTP qui répondent correctement
UserParameter=internet.endpoints.successful,OUTPUT_FORMAT=simple METRIC_NAME=successful /usr/local/bin/check-internet-endpoints-stats.sh 5

# 5. UserParameter - Nombre d'endpoints en échec
# Retourne le nombre d'endpoints HTTP qui ne répondent pas
UserParameter=internet.endpoints.failed,OUTPUT_FORMAT=simple METRIC_NAME=failed /usr/local/bin/check-internet-endpoints-stats.sh 5

# 6. UserParameter - Taux de succès en pourcentage
# Retourne le pourcentage d'endpoints accessibles
UserParameter=internet.endpoints.success_rate,OUTPUT_FORMAT=simple METRIC_NAME=success_rate /usr/local/bin/check-internet-endpoints-stats.sh 5
