---
- name: Validate professeur state variable
  ansible.builtin.assert:
    that:
      - professeur_state in ['present', 'absent']
    fail_msg: "professeur_state must be 'present' or 'absent'"

- name: Clone le-professeur repository
  ansible.builtin.git:
    repo: "https://{{ professeur_github_token }}@github.com/timox/le-professeur.git"
    dest: "{{ prod_dir }}/professeur/src"
    version: main
    force: true
  when: professeur_state == 'present'
  no_log: true

- name: Ensure directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    mode: "{{ item.mode | default('0755') }}"
  loop:
    - path: /data/professeur/mariadb
      owner: "999"
    - path: /data/professeur/sqlite
      owner: "1000"
    - path: "{{ prod_dir }}/professeur/nginx"
  when: professeur_state == 'present'

- name: Generate Professeur configs
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode | default('0644') }}"
  loop:
    - src: docker-compose.yml.j2
      dest: "{{ prod_dir }}/professeur/docker-compose.yml"
    - src: .env.j2
      dest: "{{ prod_dir }}/professeur/.env"
      mode: "0600"
    - src: nginx.conf.j2
      dest: "{{ prod_dir }}/professeur/nginx/default.conf"
  when: professeur_state == 'present'

- name: Stop existing containers
  community.docker.docker_compose_v2:
    project_src: "{{ prod_dir }}/professeur"
    project_name: "{{ professeur_project_name }}"
    state: absent
    remove_orphans: true
  when: professeur_state == 'present'

- name: Deploy Le Professeur via Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ prod_dir }}/professeur"
    project_name: "{{ professeur_project_name }}"
    env_files:
      - "{{ prod_dir }}/professeur/.env"
    state: "{{ professeur_state }}"
    build: always
    recreate: always
    remove_orphans: true
  register: professeur_deploy

- name: Wait for Le Professeur to be healthy
  ansible.builtin.uri:
    url: "http://localhost:{{ professeur_port }}/"
    status_code: 200
  register: professeur_health
  until: professeur_health.status == 200
  retries: 30
  delay: 10
  when: professeur_state == 'present'
  changed_when: false
  ignore_errors: true

- name: Show container logs on health check failure
  ansible.builtin.command:
    cmd: docker logs --tail 50 professeur-rdr
  register: rdr_logs
  when: professeur_health is failed
  changed_when: false

- name: Display rdr-observation logs
  ansible.builtin.debug:
    var: rdr_logs.stdout_lines
  when: rdr_logs is defined and rdr_logs is not skipped

- name: Fail if health check failed
  ansible.builtin.fail:
    msg: "Le Professeur health check failed. See container logs above."
  when: professeur_health is failed

- name: Display Le Professeur deployment status
  ansible.builtin.debug:
    msg: "Le Professeur is {{ 'deployed and healthy' if professeur_state == 'present' else 'removed' }}"
