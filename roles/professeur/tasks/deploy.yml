---
- name: Validate professeur state variable
  ansible.builtin.assert:
    that:
      - professeur_state in ['present', 'absent']
    fail_msg: "professeur_state must be 'present' or 'absent'"

- name: Clone le-professeur repository
  ansible.builtin.git:
    repo: "https://{{ professeur_github_token }}@github.com/timox/le-professeur.git"
    dest: "{{ prod_dir }}/professeur/src"
    version: main
    force: true
  when: professeur_state == 'present'
  no_log: true

- name: Ensure directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    mode: "{{ item.mode | default('0755') }}"
  loop:
    - path: /data/professeur/mariadb
      owner: "999"
    - path: /data/professeur/sqlite
      owner: "1000"
    - path: /data/professeur/keycloak-db
      owner: "70"
    - path: "{{ prod_dir }}/professeur/nginx"
    - path: "{{ prod_dir }}/professeur/realm-import"
  when: professeur_state == 'present'

- name: Ensure Let's Encrypt directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /data/professeur/letsencrypt
    - /data/professeur/certbot-webroot
  when: professeur_state == 'present' and (professeur_tls_enabled | default(false))

- name: Copy Keycloak realm import
  ansible.builtin.copy:
    src: professeur-realm.json
    dest: "{{ prod_dir }}/professeur/realm-import/professeur-realm.json"
    mode: '0644'
  when: professeur_state == 'present'

- name: Generate Professeur configs
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode | default('0644') }}"
  loop:
    - src: docker-compose.yml.j2
      dest: "{{ prod_dir }}/professeur/docker-compose.yml"
    - src: .env.j2
      dest: "{{ prod_dir }}/professeur/.env"
      mode: "0600"
    - src: nginx.conf.j2
      dest: "{{ prod_dir }}/professeur/nginx/default.conf"
  when: professeur_state == 'present'

- name: Obtain Let's Encrypt certificate
  ansible.builtin.command:
    cmd: >
      docker run --rm -p 80:80
      -v /data/professeur/letsencrypt:/etc/letsencrypt
      certbot/certbot certonly --standalone
      -d {{ professeur_domain }}
      --email {{ professeur_letsencrypt_email }}
      --agree-tos --non-interactive
    creates: "/data/professeur/letsencrypt/live/{{ professeur_domain }}/fullchain.pem"
  when: professeur_state == 'present' and (professeur_tls_enabled | default(false))

- name: Stop existing containers
  community.docker.docker_compose_v2:
    project_src: "{{ prod_dir }}/professeur"
    project_name: "{{ professeur_project_name }}"
    state: absent
    remove_orphans: true
  when: professeur_state == 'present'

- name: Deploy Le Professeur via Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ prod_dir }}/professeur"
    project_name: "{{ professeur_project_name }}"
    env_files:
      - "{{ prod_dir }}/professeur/.env"
    state: "{{ professeur_state }}"
    build: always
    recreate: always
    remove_orphans: true
  register: professeur_deploy

- name: Set health check base URL
  ansible.builtin.set_fact:
    _professeur_health_url: >-
      {{ 'https://localhost' if (professeur_tls_enabled | default(false)) else 'http://localhost:' ~ professeur_port }}

- name: Wait for Le Professeur to be healthy
  ansible.builtin.uri:
    url: "{{ _professeur_health_url }}/"
    status_code: [200, 301]
    validate_certs: false
  register: professeur_health
  until: professeur_health.status in [200, 301]
  retries: 30
  delay: 10
  when: professeur_state == 'present'
  changed_when: false
  ignore_errors: true

- name: Wait for Keycloak to be healthy
  ansible.builtin.uri:
    url: "{{ _professeur_health_url }}/auth/health/ready"
    status_code: 200
    validate_certs: false
  register: keycloak_health
  until: keycloak_health.status == 200
  retries: 18
  delay: 10
  when: professeur_state == 'present'
  changed_when: false
  ignore_errors: true

- name: Show container logs on health check failure
  ansible.builtin.command:
    cmd: "docker logs --tail 50 {{ item }}"
  loop:
    - professeur-rdr
    - professeur-keycloak
  register: container_logs
  when: professeur_health is failed or keycloak_health is failed
  changed_when: false

- name: Display container logs
  ansible.builtin.debug:
    msg: "{{ item.stdout_lines }}"
  loop: "{{ container_logs.results | default([]) }}"
  loop_control:
    label: "{{ item.item | default('unknown') }}"
  when: container_logs is defined and container_logs is not skipped

- name: Fail if health check failed
  ansible.builtin.fail:
    msg: "Health check failed. See container logs above."
  when: professeur_health is failed or keycloak_health is failed

- name: Display Le Professeur deployment status
  ansible.builtin.debug:
    msg: "Le Professeur is {{ 'deployed and healthy' if professeur_state == 'present' else 'removed' }}"
