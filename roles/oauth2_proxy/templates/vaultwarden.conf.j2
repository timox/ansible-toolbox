# =============================================================================
# VAULTWARDEN - Gestionnaire de mots de passe (SSO OIDC natif)
# =============================================================================
# Generated by Ansible role: oauth2_proxy (conditional on deploy_vaultwarden)
#
# Vaultwarden gere son propre SSO OIDC avec Keycloak (pas d'oauth2-proxy)
# Compatible avec tous les clients Bitwarden (mobile, desktop, navigateur)
# Administration: https://vault.{{ domain }}/admin (token dans .env)

server {
    listen 443 ssl;
    http2 on;
    server_name {{ vaultwarden_hostname_resolved }};

    ssl_certificate /certs/wildcard.{{ domain }}.crt;
    ssl_certificate_key /certs/wildcard.{{ domain }}.key;

    # Upload de fichiers (attachements)
    client_max_body_size 128M;

    # Proxy vers Vaultwarden (OIDC natif, pas d'auth_request)
    location / {
        set $upstream_vaultwarden "http://vaultwarden:80";
        proxy_pass $upstream_vaultwarden;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
    }

    # WebSocket pour synchronisation temps reel
    location /notifications/hub {
        set $upstream_vaultwarden "http://vaultwarden:80";
        proxy_pass $upstream_vaultwarden;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
}
