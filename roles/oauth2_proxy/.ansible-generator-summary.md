# oauth2_proxy Role Generation Summary

## Files Created

```
roles/oauth2_proxy/
├── defaults/main.yml           # User-configurable defaults
├── tasks/
│   ├── main.yml                # Task router
│   ├── generate_configs.yml    # Template processing (oauth2-proxy.cfg, apps.conf)
│   ├── manage_nginx_configs.yml # Conditional service configs
│   └── deploy.yml              # Docker compose deployment
├── templates/
│   ├── oauth2-proxy.cfg.j2     # oauth2-proxy config (98 lines)
│   ├── apps.conf.j2            # Main nginx config (571 lines)
│   ├── linshare.conf.j2        # LinShare nginx config (conditional)
│   ├── headscale.conf.j2       # Headscale nginx config (conditional)
│   ├── vaultwarden.conf.j2     # Vaultwarden nginx config (conditional)
│   ├── bookstack.conf.j2       # Bookstack nginx config (conditional)
│   └── config.json.j2          # Portal frontend config
├── handlers/main.yml           # restart/reload handlers
├── meta/main.yml               # Role metadata
└── README.md                   # Complete documentation
```

## Key Patterns Applied

### 1. FQCN (Fully Qualified Collection Names)

All modules use FQCN format:
- `ansible.builtin.template`
- `ansible.builtin.file`
- `ansible.builtin.command`
- `ansible.builtin.uri`
- `community.docker.docker_network`
- `community.docker.docker_compose_v2`
- `community.docker.docker_container`

### 2. Idempotency Controls

#### changed_when on read-only commands
```yaml
- name: Validate nginx configuration
  ansible.builtin.command:
    cmd: docker exec nginx-apps nginx -t
  register: nginx_validation
  changed_when: false
  failed_when: false
```

#### Conditional task execution
```yaml
- name: Generate LinShare nginx config
  ansible.builtin.template:
    src: linshare.conf.j2
    dest: "{{ oauth2_proxy_nginx_conf_dir }}/linshare.conf"
  notify: reload nginx-apps
  when: oauth2_proxy_deploy_linshare | bool

- name: Remove LinShare nginx config if disabled
  ansible.builtin.file:
    path: "{{ oauth2_proxy_nginx_conf_dir }}/linshare.conf"
    state: absent
  notify: reload nginx-apps
  when: not (oauth2_proxy_deploy_linshare | bool)
```

### 3. Secrets Handling

#### no_log on sensitive tasks
```yaml
- name: Generate oauth2-proxy.cfg from template
  ansible.builtin.template:
    src: oauth2-proxy.cfg.j2
    dest: "{{ oauth2_proxy_config_file }}"
  no_log: true
  notify: restart oauth2-proxy
```

#### Secrets from vault
```yaml
client_secret = "{{ vault_oidc_client_secret }}"
cookie_secret = "{{ vault_cookie_secret }}"
```

### 4. Template Conversion (envsubst → Jinja2)

#### Converted to Jinja2
```jinja2
# Original: ${DOMAIN}
{{ domain }}

# Original: ${KEYCLOAK_ISSUER}
{{ keycloak_issuer }}

# Original: ${OIDC_CLIENT_ID}
{{ oauth2_proxy_client_id }}
```

#### Preserved nginx runtime variables
```nginx
# These stay as-is (nginx evaluates at request time)
$host
$remote_addr
$proxy_add_x_forwarded_for
$scheme
$http_upgrade
$connection_upgrade
$upstream_http_x_auth_request_user
$upstream_http_x_auth_request_email
$upstream_http_x_auth_request_groups
$auth_user
$auth_email
$auth_groups
```

### 5. Handler Design

#### Throttled restarts for cluster safety
```yaml
- name: restart oauth2-proxy
  community.docker.docker_container:
    name: "{{ oauth2_proxy_container_name }}"
    state: started
    restart: true
  throttle: 1
```

#### Graceful nginx reload
```yaml
- name: reload nginx-apps
  ansible.builtin.command:
    cmd: docker exec nginx-apps nginx -s reload
  changed_when: true
  failed_when: false
```

### 6. Conditional Configuration Management

State-based pattern for optional services:
```yaml
# If deploy_linshare=true → create config + notify handler
# If deploy_linshare=false → remove config + notify handler
```

This ensures nginx never has stale configs for disabled services.

### 7. Verification and Health Checks

```yaml
- name: Wait for oauth2-proxy to be healthy
  ansible.builtin.uri:
    url: "http://localhost:{{ oauth2_proxy_port_http }}/ping"
    status_code: 200
  register: oauth2_proxy_health
  until: oauth2_proxy_health.status == 200
  retries: 30
  delay: 2
  changed_when: false
```

### 8. Variable Naming Convention

All role variables prefixed with `oauth2_proxy_`:
```yaml
oauth2_proxy_container_name: oauth2-proxy
oauth2_proxy_nginx_container_name: nginx-apps
oauth2_proxy_redis_container_name: oauth2-redis
oauth2_proxy_config_dir: "{{ prod_dir }}/oauth2-proxy"
oauth2_proxy_deploy_linshare: "{{ deploy_linshare }}"
```

### 9. Task Organization

Router pattern in `tasks/main.yml`:
```yaml
- include_tasks: generate_configs.yml
- include_tasks: manage_nginx_configs.yml
- include_tasks: deploy.yml
```

Each file has single responsibility:
- `generate_configs.yml`: Template processing
- `manage_nginx_configs.yml`: Conditional service configs
- `deploy.yml`: Docker compose orchestration

### 10. Docker Network Management

```yaml
- name: Ensure docker networks exist
  community.docker.docker_network:
    name: "{{ item }}"
    state: present
  loop: "{{ oauth2_proxy_networks }}"
```

## Migration from deploy.sh

### Original Logic (deploy.sh)
```bash
case "$service_name" in
    oauth2-proxy)
        envsubst < oauth2-proxy.cfg.template > oauth2-proxy.cfg
        envsubst < apps.conf.template > nginx/conf.d/apps.conf
        [ "${DEPLOY_LINSHARE}" = "true" ] && envsubst < linshare.conf.template > linshare.conf
        [ "${DEPLOY_LINSHARE}" != "true" ] && rm -f linshare.conf
        docker compose up -d
        ;;
esac
```

### Ansible Equivalent
```yaml
# tasks/generate_configs.yml
- ansible.builtin.template:
    src: oauth2-proxy.cfg.j2
    dest: "{{ oauth2_proxy_config_file }}"

- ansible.builtin.template:
    src: apps.conf.j2
    dest: "{{ oauth2_proxy_nginx_conf_dir }}/apps.conf"

# tasks/manage_nginx_configs.yml
- ansible.builtin.template:
    src: linshare.conf.j2
    dest: "{{ oauth2_proxy_nginx_conf_dir }}/linshare.conf"
  when: oauth2_proxy_deploy_linshare | bool

- ansible.builtin.file:
    path: "{{ oauth2_proxy_nginx_conf_dir }}/linshare.conf"
    state: absent
  when: not (oauth2_proxy_deploy_linshare | bool)

# tasks/deploy.yml
- community.docker.docker_compose_v2:
    project_src: "{{ oauth2_proxy_config_dir }}"
    state: present
```

## Critical Template Conversion Notes

### Nginx Variables Must Be Preserved

**WRONG** (would break nginx):
```jinja2
proxy_set_header Host {{ host }};  # ❌ Jinja2 treats $host as variable
```

**CORRECT**:
```jinja2
proxy_set_header Host $host;  # ✅ Nginx evaluates $host at runtime
```

### Variable Substitution Examples

```jinja2
# Ansible variables (evaluated during template processing)
server_name {{ portal_hostname_resolved }};
ssl_certificate /certs/wildcard.{{ domain }}.crt;
set $upstream_oauth2 "http://{{ oauth2_proxy_container_name }}:{{ oauth2_proxy_port_http }}";

# Nginx variables (evaluated at request time)
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
auth_request_set $auth_user $upstream_http_x_auth_request_user;
```

## Validation Command

```bash
cd /home/ubuntu/app/pomeguac/environments/prod/ansible
uv run ansible-playbook playbooks/deploy-oauth2-proxy.yml --check --diff
```

## Testing Checklist

- [ ] oauth2-proxy.cfg generated with correct OIDC issuer
- [ ] apps.conf contains portal, guacamole, keycloak configs
- [ ] Conditional configs generated only when deploy_<service>=true
- [ ] Conditional configs removed when deploy_<service>=false
- [ ] nginx -t validation passes
- [ ] oauth2-proxy container starts and /ping returns 200
- [ ] nginx-apps container starts and serves requests
- [ ] redis container starts and stores sessions
- [ ] Handler triggers on config changes
- [ ] No secrets in logs (no_log working)

## Compliance with Repository Conventions

✅ FQCN used throughout
✅ changed_when on command/shell tasks
✅ no_log on secret-handling tasks
✅ Variables prefixed with role name
✅ Handlers use throttle for cluster safety
✅ Task files split by responsibility
✅ Templates converted from envsubst to Jinja2
✅ Nginx runtime variables preserved
✅ Conditional config management implemented
✅ Validation and health checks included
✅ README.md with complete documentation
✅ meta/main.yml with role metadata

## Next Steps

1. Create playbook `playbooks/deploy-oauth2-proxy.yml`
2. Add role to `playbooks/site.yml`
3. Test with `--check` mode first
4. Run validation commands
5. Verify services are accessible
