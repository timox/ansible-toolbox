---
# Called by secrets.yml for each secret entry
# Variables: secret.name, secret.var, secret.type

- name: "Check if {{ secret.name }} is already set"
  ansible.builtin.set_fact:
    _secret_value: "{{ lookup('vars', secret.var, default='') }}"
  no_log: true

- name: "Generate {{ secret.name }} (type: {{ secret.type }})"
  block:
    - name: "Generate base64 secret for {{ secret.name }}"
      ansible.builtin.command:
        cmd: python3 -c "import os,base64; print(base64.urlsafe_b64encode(os.urandom(32)).decode())"
      register: _generated_base64
      changed_when: false
      no_log: true
      when: secret.type == 'base64'

    - name: "Generate base64-48 secret for {{ secret.name }}"
      ansible.builtin.command:
        cmd: openssl rand -base64 48
      register: _generated_base64_48
      changed_when: false
      no_log: true
      when: secret.type == 'base64-48'

    - name: "Generate hex-16 secret for {{ secret.name }}"
      ansible.builtin.command:
        cmd: openssl rand -hex 16
      register: _generated_hex_16
      changed_when: false
      no_log: true
      when: secret.type == 'hex-16'

    - name: "Set generated value for {{ secret.name }}"
      ansible.builtin.set_fact:
        _new_secret: >-
          {%- if secret.type == 'base64' -%}{{ _generated_base64.stdout }}{%- elif secret.type == 'base64-48' -%}{{ _generated_base64_48.stdout }}{%- elif secret.type == 'hex-16' -%}{{ _generated_hex_16.stdout }}{%- endif -%}
      no_log: true

    - name: "Write {{ secret.name }} to .env"
      ansible.builtin.lineinfile:
        path: "{{ env_file }}"
        regexp: "^{{ secret.name }}="
        line: "{{ secret.name }}={{ _new_secret }}"
        create: false
      no_log: true

    - name: "Register {{ secret.name }} as fact"
      ansible.builtin.set_fact:
        "{{ secret.var }}": "{{ _new_secret }}"
      no_log: true

    - name: "Secret {{ secret.name }} generated"
      ansible.builtin.debug:
        msg: "{{ secret.name }} generated and written to .env"

  when: _secret_value | length == 0

- name: "Secret {{ secret.name }} already configured"
  ansible.builtin.debug:
    msg: "{{ secret.name }} already set"
    verbosity: 1
  when: _secret_value | length > 0
