---
# ============================================================================
# System configuration (timezone, locale, hostname, swap)
# ============================================================================

- name: Set timezone
  community.general.timezone:
    name: "{{ bootstrap_timezone }}"

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ bootstrap_hostname }}"

- name: Ensure hostname in /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: "^127\\.0\\.1\\.1"
    line: "127.0.1.1 {{ bootstrap_hostname }}"
    state: present

- name: Generate locale
  community.general.locale_gen:
    name: "{{ bootstrap_locale }}"
    state: present

# --- Swap ---

- name: Check if swap file exists
  ansible.builtin.stat:
    path: "{{ bootstrap_swap_path }}"
  register: swap_file
  when: bootstrap_configure_swap | bool

- name: Create swap file
  ansible.builtin.command:
    cmd: "fallocate -l {{ bootstrap_swap_size }} {{ bootstrap_swap_path }}"
    creates: "{{ bootstrap_swap_path }}"
  when:
    - bootstrap_configure_swap | bool
    - not swap_file.stat.exists
  register: swap_created

- name: Set swap file permissions
  ansible.builtin.file:
    path: "{{ bootstrap_swap_path }}"
    mode: "0600"
  when: bootstrap_configure_swap | bool

- name: Format swap file
  ansible.builtin.command:
    cmd: "mkswap {{ bootstrap_swap_path }}"
  when:
    - bootstrap_configure_swap | bool
    - swap_created is changed
  changed_when: true

- name: Enable swap file
  ansible.builtin.command:
    cmd: "swapon {{ bootstrap_swap_path }}"
  when:
    - bootstrap_configure_swap | bool
    - swap_created is changed
  changed_when: true

- name: Add swap to fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: "{{ bootstrap_swap_path }}"
    line: "{{ bootstrap_swap_path }} none swap sw 0 0"
    state: present
  when: bootstrap_configure_swap | bool
